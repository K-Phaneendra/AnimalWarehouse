import React, { Component } from 'react';
import { connect } from 'react-redux';
import { Row, Col } from 'react-bootstrap';
import FormDialog from '../../components/Modals/FormDialog';
import CreateAnnouncement from './CreateAnnouncement';
import {
  createAnnouncement,
  updateAnnouncement
} from '../../actions/animalActions';
import { handleSnackBar } from '../../actions/DashboardAction';
import {
  generateAnimalSpecieOptions,
  generateAttributeOptions
} from '../../helpers/reusableFunctions';
import {
  announcementTableColumns
  // announcemetAnimalColumns
} from '../Dashboard/TableColumns';
import CheckBoxTable from '../../components/Table/CheckboxTable';

class AnnouncementsTableView extends Component {
  constructor() {
    super();
    this.state = {
      openCreateAnnouncement: false,
      disableSubmit: true,
      cartData: [{}],
      attributesCart: [{}],
      announcementName: '',
      selection: [],
      selectAll: false,
      openEditAnnouncement: false,
      selectedStatusOnEdit: {}
    };
  }
  onSubmit = () => {
    console.log('loggedinuser', this.props.loggedInUser);
    const dbObj = {
      name: this.state.announcementName,
      animals: this.state.cartData,
      attributes: this.state.attributesCart,
      createdBy: this.props.loggedInUser.id,
      createdDate: new Date(),
      status: 'PENDING'
    };
    this.props.dispatch(createAnnouncement(dbObj, this.callBack));
  };
  onSubmitEdit = () => {
    console.log('loggedinuser', this.props.loggedInUser);
    const dbObj = {
      name: this.state.announcementName,
      animals: this.state.cartData,
      attributes: this.state.attributesCart,
      createdBy: this.props.loggedInUser.id,
      status: this.state.selectedStatusOnEdit.value
    };
    this.props.dispatch(
      updateAnnouncement(dbObj, this.state.selection[0], this.callBack)
    );
  };
  getSelectedRowData = (selection, announcements) => {
    const objectId = '_id';
    let selectedRowObj = {};
    announcements.map(anncmnts => {
      if (selection.indexOf(anncmnts[objectId]) >= 0) {
        selectedRowObj = anncmnts;
      }
      return null;
    });
    return selectedRowObj;
  };
  incrementAttributeCart = () => {
    const { attributesCart } = this.state;
    const incrementedCartData = this.incrementedCartData(attributesCart);
    this.setState({ attributesCart: incrementedCartData });
  };
  incrementedCartData = cartData => {
    cartData.push({});
    return cartData;
  };
  incrementCart = () => {
    const { cartData } = this.state;
    const incrementedCartData = this.incrementedCartData(cartData);
    this.setState({ cartData: incrementedCartData });
  };
  selectSpecie = (e, count) => {
    const { cartData } = this.state;
    cartData.map((values, index) => {
      if (index === count) {
        // eslint-disable-next-line
        values.specie = e.value;
        // eslint-disable-next-line
        values.selectedSpecie = e;
      }
      return null;
    });
    this.setState({ cartData });
  };
  textOnBlur = (e, count) => {
    const { cartData } = this.state;
    cartData.map((values, index) => {
      if (index === count) {
        if (e.target.type === 'number') {
          // eslint-disable-next-line
          values[e.target.name] = Number(e.target.value);
        } else {
          // eslint-disable-next-line
          values[e.target.name] = e.target.value;
        }
      }
      return null;
    });
    this.setState({ cartData });
  };
  attributeValuesOnBlur = (e, count) => {
    const { attributesCart } = this.state;
    attributesCart.map((values, index) => {
      if (index === count) {
        if (e.target.type === 'number') {
          // eslint-disable-next-line
          values[e.target.name] = Number(e.target.value);
        } else {
          // eslint-disable-next-line
          values[e.target.name] = e.target.value;
        }
      }
      return null;
    });
    this.setState({ attributesCart });
  };
  decrementCart = count => {
    const { cartData } = this.state;
    const decrementedCart = [];
    cartData.map((values, index) => {
      if (count === index) {
        // do nothing
      } else {
        decrementedCart.push(values);
      }
      return null;
    });
    if (decrementedCart.length === 0) {
      decrementedCart.push({});
    }
    this.setState({ cartData: decrementedCart });
  };
  decrementAttributeCart = count => {
    const { attributesCart } = this.state;
    const decrementedCart = [];
    attributesCart.map((values, index) => {
      if (count === index) {
        // do nothing
      } else {
        decrementedCart.push(values);
      }
      return null;
    });
    if (decrementedCart.length === 0) {
      decrementedCart.push({});
    }
    this.setState({ attributesCart: decrementedCart });
  };
  selectAttribute = (e, count) => {
    const { attributesCart } = this.state;
    attributesCart.map((values, index) => {
      if (index === count) {
        // eslint-disable-next-line
        values.attribute = e.value;
        // eslint-disable-next-line
        values.selectedAttribute = e;
      }
      return null;
    });
    this.setState({ attributesCart });
  };
  announcementName = e => {
    this.setState({ announcementName: e.target.value });
  };
  callBack = APIresponse => {
    this.props.dispatch(
      handleSnackBar({ snackBarOpen: true, snackBarMsg: APIresponse.message })
    );
    if (!APIresponse.error) {
      this.setState({
        openCreateAnnouncement: false,
        openEditAnnouncement: false
      });
    }
  };
  toggleSelection = (selection, announcements) => {
    const selectedRowData = this.getSelectedRowData(selection, announcements);
    this.setState({
      selection,
      cartData: selectedRowData.animals,
      attributesCart: selectedRowData.attributes,
      announcementName: selectedRowData.name,
      selectedStatusOnEdit: {
        value: selectedRowData.status,
        label: selectedRowData.status
      }
    });
  };

  editAnnouncement = () => {
    if (this.state.selection.length === 0 || this.state.selection.length > 1) {
      alert('Please select one row to edit');
    } else {
      this.setState({ openEditAnnouncement: true });
    }
  };
  render() {
    const { animalSpecies, attributes, announcements } = this.props;
    let { disableSubmit } = this.state;
    const animalOptions = generateAnimalSpecieOptions(animalSpecies);
    const attributeOptions = generateAttributeOptions(attributes);
    const { cartData, attributesCart, announcementName } = this.state;
    if (
      cartData[0].specie &&
      cartData[0].quantity &&
      attributesCart[0].attribute &&
      attributesCart[0].min &&
      attributesCart[0].max &&
      announcementName !== ''
    ) {
      disableSubmit = false;
    }
    return (
      <div>
        <Row className="margin-bottom10">
          <Col lg={3} md={4} className="action-wrap">
            <ul className="action-buttons">
              <li>
                <i
                  className="fas fa-plus"
                  aria-hidden="true"
                  onClick={() =>
                    this.setState({ openCreateAnnouncement: true })
                  }
                  title="Create Announcement"
                />
              </li>
              <li>
                <i
                  className="far fa-edit"
                  aria-hidden="true"
                  onClick={this.editAnnouncement}
                  title="Edit Announcement"
                />
              </li>
            </ul>
          </Col>
        </Row>

        <FormDialog
          open={this.state.openCreateAnnouncement}
          onClose={() => this.setState({ openCreateAnnouncement: false })}
          formTitle="Create Announcement"
          formContent={
            <CreateAnnouncement
              animalSpecies={animalSpecies}
              attributes={attributes}
              cartData={cartData}
              animalOptions={animalOptions}
              incrementCart={this.incrementCart}
              selectSpecie={this.selectSpecie}
              textOnBlur={this.textOnBlur}
              decrementCart={this.decrementCart}
              attributesCart={attributesCart}
              attributeOptions={attributeOptions}
              incrementAttributeCart={this.incrementAttributeCart}
              selectAttribute={this.selectAttribute}
              attributeTextOnBlur={this.attributeTextOnBlur}
              attributeValuesOnBlur={this.attributeValuesOnBlur}
              decrementAttributeCart={this.decrementAttributeCart}
              announcementName={this.announcementName}
            />
          }
          disableSubmit={disableSubmit}
          onSubmit={this.onSubmit}
        />
        <FormDialog
          open={this.state.openEditAnnouncement}
          onClose={() => this.setState({ openEditAnnouncement: false })}
          formTitle="Edit Announcement"
          formContent={
            <CreateAnnouncement
              animalSpecies={animalSpecies}
              attributes={attributes}
              cartData={cartData}
              animalOptions={animalOptions}
              incrementCart={this.incrementCart}
              selectSpecie={this.selectSpecie}
              textOnBlur={this.textOnBlur}
              decrementCart={this.decrementCart}
              attributesCart={attributesCart}
              attributeOptions={attributeOptions}
              incrementAttributeCart={this.incrementAttributeCart}
              selectAttribute={this.selectAttribute}
              attributeTextOnBlur={this.attributeTextOnBlur}
              attributeValuesOnBlur={this.attributeValuesOnBlur}
              decrementAttributeCart={this.decrementAttributeCart}
              announcementName={this.announcementName}
              edit
              anncmentName={this.state.announcementName}
              selectAnncmntStatus={e =>
                this.setState({ selectedStatusOnEdit: e })
              }
              selectedStatusOnEdit={this.state.selectedStatusOnEdit}
            />
          }
          disableSubmit={disableSubmit}
          onSubmit={this.onSubmitEdit}
        />
        <div>
          <CheckBoxTable
            toggleSelection={selection =>
              this.toggleSelection(selection, announcements)
            }
            toggleAll={(selectAll, selection) =>
              this.setState({ selectAll, selection })
            }
            selection={this.state.selection}
            selectAll={this.state.selectAll}
            data={announcements}
            columns={announcementTableColumns}
          />
        </div>
      </div>
    );
  }
}

export default connect()(AnnouncementsTableView);
